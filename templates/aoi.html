{% extends 'base.html' %}
{% block title %}AOI Daily Report{% endblock %}
{% block content %}
  <a href="/">‚Üê Home</a>
  <h1>AOI Daily Report</h1>
  <p>
    <a href="/aoi">View Reports</a>
    {% if current_user == 'ADMIN' or permissions['aoi'] %}
      | <a href="/aoi?view=upload">Upload Report</a>
      | <a href="{{ url_for('aoi_dashboard') }}">Dashboard</a>
    {% endif %}
  </p>

  {% if upload %}
    {% if current_user == 'ADMIN' or permissions['aoi'] %}
    <div class="action-panel">
      <div class="action-card">
        <h2>Upload Daily Report</h2>
        <p class="desc">Choose the AOI report file and optionally set the report date.</p>
        <form method="post" enctype="multipart/form-data">
          <label>Report Date
            <input type="date" name="report_date">
          </label><br>
          <label>Excel File
            <input type="file" name="excel_file" accept=".xls,.xlsx" required>
          </label><br>
          <p class="field-desc">If left blank, the date from the file will be used.</p>
          <button type="submit">Upload</button>
        </form>
      </div>
    </div>
    {% else %}
      <p>Not authorized.</p>
    {% endif %}
  {% else %}
    <div class="action-panel">
      <div class="action-card">
        <h2>View Daily Report</h2>
        <form method="get" action="/aoi">
          <label for="date-select">Select Date</label>
          <select id="date-select" name="date">
            {% for d in available_dates %}
            <option value="{{ d }}" {% if d == selected_date %}selected{% endif %}>{{ d }}</option>
            {% endfor %}
          </select>
          <input type="date" id="manual-date" value="{{ selected_date }}">
          <button type="submit">View</button>
        </form>
        <script>
          const manualDate = document.getElementById('manual-date');
          const dateSelect = document.getElementById('date-select');
          manualDate.addEventListener('change', () => {
            dateSelect.value = manualDate.value;
          });
        </script>
      </div>
    </div>
    {% if selected_date %}
      {% if html_exists %}
        <iframe src="{{ url_for('aoi_html', filename=selected_date + '.html') }}" width="100%" height="600"></iframe>
      {% elif data %}
        {% for shift, rows in data.items() %}
          <h2>{{ shift }} Shift</h2>
          <table>
            <tr>
              <th>Operator</th>
              <th>Customer</th>
              <th>Assembly</th>
              <th>Quantity Inspected</th>
              <th>Quantity Rejected</th>
              <th>Additional Information</th>
            </tr>
            {% for r in rows %}
            <tr>
              <td>{{ r['operator'] }}</td>
              <td>{{ r['customer'] }}</td>
              <td>{{ r['assembly'] }}</td>
              <td>{{ r['qty_inspected'] }}</td>
              <td>{{ r['qty_rejected'] }}</td>
              <td>{{ r['additional_info'] }}</td>
            </tr>
            {% endfor %}
          </table>
        {% endfor %}
      {% else %}
        <p>No report found for {{ selected_date }}.</p>
      {% endif %}
    {% endif %}
  {% endif %}
{% endblock %}
