{% extends 'base.html' %}
{% block title %}AOI Daily Report{% endblock %}
{% block head_extra %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js" defer></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js" defer></script>
  <script id="operator-data" type="application/json">{{ operators|tojson }}</script>
  <script id="shift-data" type="application/json">{{ shift_totals|tojson }}</script>
  <script id="customer-data" type="application/json">{{ customer_rates|tojson }}</script>
  <script id="yield-data" type="application/json">{{ yield_series|tojson }}</script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
  <script src="{{ url_for('static', filename='js/aoi_dashboard.js') }}" defer></script>
{% endblock %}
{% block content %}
  <a href="/">‚Üê Home</a>
  <h1>AOI Daily Report</h1>
  <div id="container">
    <div id="aoi-actions">
      <div class="action-panel">
        {% if current_user == 'ADMIN' or permissions['aoi'] %}
        <div class="action-card">
          <h2>Add New Entry</h2>
          <form method="post">
            <label>Report Date
              <input type="date" name="report_date" required>
            </label><br>
            <label>Shift
              <select name="shift" required>
                <option value="1st">1st</option>
                <option value="2nd">2nd</option>
              </select>
            </label><br>
            <label>Operator
              <input type="text" name="operator" required>
            </label><br>
            <label>Customer
              <input type="text" name="customer">
            </label><br>
            <label>Assembly
              <input type="text" name="assembly">
            </label><br>
            <label>Quantity Inspected
              <input type="number" name="qty_inspected" min="0">
            </label><br>
            <label>Quantity Rejected
              <input type="number" name="qty_rejected" min="0">
            </label><br>
            <label>Additional Information
              <input type="text" name="additional_info">
            </label><br>
            <button type="submit">Add</button>
          </form>
        </div>
        <div class="action-card">
          <h2>Bulk Upload</h2>
          <form method="post" enctype="multipart/form-data">
            <label>Report Date
              <input type="date" name="report_date" required>
            </label><br>
            <label>Shift
              <select name="shift" required>
                <option value="1st">1st</option>
                <option value="2nd">2nd</option>
              </select>
            </label><br>
            <label>Excel File
              <input type="file" name="excel_file" accept=".xls,.xlsx" required>
            </label><br>
            <button type="submit">Upload</button>
          </form>
        </div>
        {% endif %}
        <div class="action-card">
          <h2>Data Mining Filters</h2>
          <form method="get" action="/aoi">
            <label>Start: <input type="date" name="start" value="{{ start or '' }}"></label><br>
            <label>End: <input type="date" name="end" value="{{ end or '' }}"></label><br>
            <label>Customer:
              <select name="customer">
                <option value="">All</option>
                {% for c in customers %}
                <option value="{{ c }}" {% if c == selected_customer %}selected{% endif %}>{{ c }}</option>
                {% endfor %}
              </select>
            </label><br>
            <label>Shift:
              <select name="shift">
                <option value="">All</option>
                {% for s in shifts %}
                <option value="{{ s }}" {% if s == selected_shift %}selected{% endif %}>{{ s }}</option>
                {% endfor %}
              </select>
            </label><br>
            <button type="submit">Apply</button>
          </form>
        </div>
        <h2>Top Operators by Inspected Quantity <button class="expand-chart" data-chart="operators" data-title="Top Operators by Inspected Quantity">Expand</button></h2>
        <canvas id="operatorsChart"></canvas>
        <h2>Shift Totals <button class="expand-chart" data-chart="shift" data-title="Shift Totals">Expand</button></h2>
        <canvas id="shiftChart"></canvas>
        <h2>Customer Reject Rates <button class="expand-chart" data-chart="customer" data-title="Customer Reject Rates">Expand</button></h2>
        <canvas id="customerChart"></canvas>
        <h2>Overall Yield Over Time <button class="expand-chart" data-chart="yield" data-title="Overall Yield Over Time">Expand</button></h2>
        <canvas id="yieldChart"></canvas>
        <h2>Assembly Performance</h2>
        <table id="assemblyTable">
          <thead>
            <tr>
              <th>Assembly</th>
              <th>Inspected</th>
              <th>Rejected</th>
              <th>Yield</th>
            </tr>
          </thead>
          <tbody>
            {% for row in assemblies %}
            <tr>
              <td>{{ row['assembly'] }}</td>
              <td>{{ row['inspected'] }}</td>
              <td>{{ row['rejected'] }}</td>
              <td>{{ '{:.2%}'.format(row['yield']) }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    <div id="divider"></div>
    <div id="aoi-table">
      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Shift</th>
            <th>Operator</th>
            <th>Customer</th>
            <th>Assembly</th>
            <th>Quantity Inspected</th>
            <th>Quantity Rejected</th>
            <th>Additional Information</th>
            {% if current_user == 'ADMIN' or permissions['aoi'] %}
            <th>Actions</th>
            {% endif %}
          </tr>
        </thead>
        <tbody>
          {% for r in records %}
          <tr data-id="{{ r['id'] }}">
            <td>{{ r['report_date'] }}</td>
            <td>{{ r['shift'] }}</td>
            <td>{{ r['operator'] }}</td>
            <td>{{ r['customer'] }}</td>
            <td>{{ r['assembly'] }}</td>
            <td>{{ r['qty_inspected'] }}</td>
            <td>{{ r['qty_rejected'] }}</td>
            <td>{{ r['additional_info'] }}</td>
            {% if current_user == 'ADMIN' or permissions['aoi'] %}
            <td class="no-edit"><button type="button" class="delete-row">Delete</button></td>
            {% endif %}
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <div id="chart-modal" class="modal">
    <div class="modal-content">
      <span id="close-chart-modal" class="close">&times;</span>
      <h2 id="chart-modal-title"></h2>
      <canvas id="chart-canvas"></canvas>
      <button id="download-chart-pdf">Download PDF</button>
    </div>
  </div>
{% endblock %}

