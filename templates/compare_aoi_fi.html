{% extends 'base.html' %}
{% block title %}AOI vs Final Inspect Comparison{% endblock %}
{% block head_extra %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
  <script id="aoi-series" type="application/json">{{ aoi_series|tojson }}</script>
  <script id="fi-series" type="application/json">{{ fi_series|tojson }}</script>
  <script id="aoi-data" type="application/json">{{ aoi_rows|tojson }}</script>
  <script id="fi-data" type="application/json">{{ fi_rows|tojson }}</script>
  <script id="grade-data" type="application/json">{{ grades|tojson }}</script>
  <script src="{{ url_for('static', filename='js/report_utils.js') }}" defer></script>
  <script src="{{ url_for('static', filename='js/tabs.js') }}" defer></script>
  <script src="{{ url_for('static', filename='js/chart_modal.js') }}" defer></script>
  <script src="{{ url_for('static', filename='js/aoi_fi_compare.js') }}" defer></script>
{% endblock %}
{% block content %}
  <h1>AOI vs Final Inspect Comparison</h1>
  <form method="get" style="margin-bottom:20px;">
    <label>Start: <input type="date" name="start" value="{{ start or '' }}"></label>
    <label>End: <input type="date" name="end" value="{{ end or '' }}"></label>
    <button type="submit">Apply</button>
  </form>
  <div class="chart-grid">
    <div class="chart-widget">
      <h2>AOI Operator Grades <button class="expand-chart" data-chart="grades" aria-label="Expand chart">⤢</button></h2>
      <canvas id="operatorGradesChart"></canvas>
    </div>
    <div class="chart-widget">
      <h2>Yield Comparison <button class="expand-chart" data-chart="yield" aria-label="Expand chart">⤢</button></h2>
      <canvas id="yieldOverlayChart"></canvas>
    </div>
  </div>
  <div class="comparison-panels" style="display:flex; gap:20px; flex-wrap:wrap; margin-top:20px;">
    <details class="panel" style="flex:1;" open>
      <summary>AOI Reports</summary>
      <table id="compare-aoi-table">
        <thead>
          <tr>
            <th>Date</th>
            <th>Shift</th>
            <th>Operator</th>
            <th>Customer</th>
            <th>Assembly</th>
            <th>Rev</th>
            <th>Job</th>
            <th>Inspected</th>
            <th>Rejected</th>
            <th>Info</th>
          </tr>
        </thead>
        <tbody>
          {% for r in aoi_rows %}
          <tr>
            <td>{{ r['report_date'] }}</td>
            <td>{{ r['shift'] }}</td>
            <td>{{ r['operator'] }}</td>
            <td>{{ r['customer'] }}</td>
            <td>{{ r['assembly'] }}</td>
            <td>{{ r['rev'] }}</td>
            <td>{{ r['job_number'] }}</td>
            <td>{{ r['qty_inspected'] }}</td>
            <td>{{ r['qty_rejected'] }}</td>
            <td>{{ r['additional_info'] }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      <button type="button" onclick="exportTableToExcel('#compare-aoi-table','aoi_reports.csv')">Export CSV</button>
    </details>
    <details class="panel" style="flex:1;" open>
      <summary>Final Inspect Reports</summary>
      <table id="compare-fi-table">
        <thead>
          <tr>
            <th>Date</th>
            <th>Shift</th>
            <th>Operator</th>
            <th>Customer</th>
            <th>Assembly</th>
            <th>Rev</th>
            <th>Job</th>
            <th>Inspected</th>
            <th>Rejected</th>
            <th>Info</th>
          </tr>
        </thead>
        <tbody>
          {% for r in fi_rows %}
          <tr>
            <td>{{ r['report_date'] }}</td>
            <td>{{ r['shift'] }}</td>
            <td>{{ r['operator'] }}</td>
            <td>{{ r['customer'] }}</td>
            <td>{{ r['assembly'] }}</td>
            <td>{{ r['rev'] }}</td>
            <td>{{ r['job_number'] }}</td>
            <td>{{ r['qty_inspected'] }}</td>
            <td>{{ r['qty_rejected'] }}</td>
            <td>{{ r['additional_info'] }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      <button type="button" onclick="exportTableToExcel('#compare-fi-table','final_inspect_reports.csv')">Export CSV</button>
    </details>
  </div>
  <div class="modal fade" id="chart-modal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modal-chart-title"></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="chart-container chart-widget--detail">
            <canvas id="modal-chart"></canvas>
          </div>
          <table id="modal-table">
            <thead></thead>
            <tbody></tbody>
          </table>
          <button type="button" onclick="exportTableToExcel('#modal-table','modal_data.csv')">Export CSV</button>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

