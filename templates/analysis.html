{% extends 'base.html' %}
{% block title %}Data Analysis - PPM MOAT & Control Chart{% endblock %}
{% block head_extra %}
  <!-- Chart.js for control chart rendering -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.25/dist/jspdf.plugin.autotable.min.js" defer></script>
    <script src="{{ url_for('static', filename='js/report_utils.js') }}" defer></script>
    <script src="{{ url_for('static', filename='js/tabs.js') }}" defer></script>
    <script src="/static/js/analysis.js" defer></script>
    <script src="{{ url_for('static', filename='js/moat_sql.js') }}" defer></script>
{% endblock %}
{% block content %}
  <a href="/">‚Üê Home</a>
  <h1>Data Analysis - PPM MOAT</h1>
  {% if not show_moat %}
    <button onclick="window.location='{{ url_for('analysis') }}?view=moat'">View PPM Reports</button>
  {% else %}
    <div class="moat-stats">
      {% if total_rows %}
        Total rows: {{ total_rows }} | Table range: {{ earliest }} - {{ latest }}
        {% if is_admin or permissions['analysis'] %}
        &nbsp;|&nbsp;
        <button id="show-uploads-btn" title="View or delete previously uploaded reports">Manage Uploads</button>
        {% endif %}
      {% endif %}
    </div>
    <div id="container">
      <div id="analysis-actions">
        <nav class="tab-nav">
          <button class="tab-link active" data-tab="actions-tab">Actions</button>
          <button class="tab-link" data-tab="reports-tab">Reports</button>
        </nav>
        <div id="actions-tab" class="tab-content active">
          <div class="action-panel">
            {% if is_admin or permissions['analysis'] %}
            <div class="action-card">
              <h2>Upload PPM Report</h2>
              <p class="desc">Import a PPM report (.xls or .xlsx) to analyze false call rates.</p>
              <form method="post" enctype="multipart/form-data">
                <label for="ppm_report">Choose file</label>
                <input id="ppm_report" type="file" name="ppm_report" accept=".xls,.xlsx" required title="PPM report Excel file">
                <p class="field-desc">Upload the selected report for processing.</p>
                <button type="submit" title="Upload and analyze the report">Upload Report</button>
              </form>
            </div>
            {% endif %}
            <div class="action-card">
              <h2>Control Chart - Avg FCs</h2>
              <p class="desc">Configure options and generate a false call rate control chart.</p>
              <button id="control-chart-btn" title="Show or hide chart options">Control Chart Settings</button>
              <div id="chart-settings" style="display:none; margin-top:10px;">
                <label>Start Date
                  <input type="date" id="start-date" title="Start date for data range">
                </label><br>
                <label>End Date
                  <input type="date" id="end-date" title="End date for data range">
                </label><br>
                <label>Y Max
                  <input type="number" id="y-max" value="50" step="0.1" title="Maximum value for Y-axis">
                </label><br>
                <label>Min Boards
                  <input type="number" id="min-boards" value="7" title="Minimum boards required">
                </label><br>
                <label>Model Name
                  <input list="model-list" id="model-name-1" placeholder="Start typing..." title="Select model name">
                  <span id="model-name-and-2" style="display:none">and</span>
                  <input list="model-list" id="model-name-2" style="display:none" placeholder="Start typing..." title="Select model name">
                  <span id="model-name-and-3" style="display:none">and</span>
                  <input list="model-list" id="model-name-3" style="display:none" placeholder="Start typing..." title="Select model name">
                  <span id="model-name-and-4" style="display:none">and</span>
                  <input list="model-list" id="model-name-4" style="display:none" placeholder="Start typing..." title="Select model name">
                </label><br>
                <label>Lines
                  <select id="line-select-1">
                    <option value="all">All Lines</option>
                    <option value="offline">Line Offline</option>
                    <option value="0">Line 0</option>
                    <option value="1">Line 1</option>
                    <option value="2">Line 2</option>
                    <option value="3">Line 3</option>
                  </select>
                  <span id="line-and-2" style="display:none">and</span>
                  <select id="line-select-2" style="display:none">
                    <option value="">-- Select --</option>
                    <option value="offline">Line Offline</option>
                    <option value="0">Line 0</option>
                    <option value="1">Line 1</option>
                    <option value="2">Line 2</option>
                    <option value="3">Line 3</option>
                  </select>
                  <span id="line-and-3" style="display:none">and</span>
                  <select id="line-select-3" style="display:none">
                    <option value="">-- Select --</option>
                    <option value="offline">Line Offline</option>
                    <option value="0">Line 0</option>
                    <option value="1">Line 1</option>
                    <option value="2">Line 2</option>
                    <option value="3">Line 3</option>
                  </select>
                  <span id="line-and-4" style="display:none">and</span>
                  <select id="line-select-4" style="display:none">
                    <option value="">-- Select --</option>
                    <option value="offline">Line Offline</option>
                    <option value="0">Line 0</option>
                    <option value="1">Line 1</option>
                    <option value="2">Line 2</option>
                    <option value="3">Line 3</option>
                  </select>
                </label><br>
                <p class="field-desc">Generate the chart using the selected parameters.</p>
                <button id="run-chart-btn" title="Generate control chart">Run Chart</button>
              </div>
            </div>
            <div class="action-card">
              <h2>Control Chart - Avg NGs</h2>
              <p class="desc">Configure options and generate an NG rate control chart.</p>
              <button id="control-chart-ng-btn" title="Show or hide chart options">Control Chart Settings</button>
              <div id="chart-ng-settings" style="display:none; margin-top:10px;">
                <label>Start Date
                  <input type="date" id="ng-start-date" title="Start date for data range">
                </label><br>
                <label>End Date
                  <input type="date" id="ng-end-date" title="End date for data range">
                </label><br>
                <label>Y Max
                  <input type="number" id="ng-y-max" value="1" step="0.01" title="Maximum value for Y-axis">
                </label><br>
                <label>Min Boards
                  <input type="number" id="ng-min-boards" value="7" title="Minimum boards required">
                </label><br>
                <label>Model Name
                  <input list="model-list" id="ng-model-name-1" placeholder="Start typing..." title="Select model name">
                  <span id="ng-model-name-and-2" style="display:none">and</span>
                  <input list="model-list" id="ng-model-name-2" style="display:none" placeholder="Start typing..." title="Select model name">
                  <span id="ng-model-name-and-3" style="display:none">and</span>
                  <input list="model-list" id="ng-model-name-3" style="display:none" placeholder="Start typing..." title="Select model name">
                  <span id="ng-model-name-and-4" style="display:none">and</span>
                  <input list="model-list" id="ng-model-name-4" style="display:none" placeholder="Start typing..." title="Select model name">
                </label><br>
                <label>Lines
                  <select id="ng-line-select-1">
                    <option value="all">All Lines</option>
                    <option value="offline">Line Offline</option>
                    <option value="0">Line 0</option>
                    <option value="1">Line 1</option>
                    <option value="2">Line 2</option>
                    <option value="3">Line 3</option>
                  </select>
                  <span id="ng-line-and-2" style="display:none">and</span>
                  <select id="ng-line-select-2" style="display:none">
                    <option value="">-- Select --</option>
                    <option value="offline">Line Offline</option>
                    <option value="0">Line 0</option>
                    <option value="1">Line 1</option>
                    <option value="2">Line 2</option>
                    <option value="3">Line 3</option>
                  </select>
                  <span id="ng-line-and-3" style="display:none">and</span>
                  <select id="ng-line-select-3" style="display:none">
                    <option value="">-- Select --</option>
                    <option value="offline">Line Offline</option>
                    <option value="0">Line 0</option>
                    <option value="1">Line 1</option>
                    <option value="2">Line 2</option>
                    <option value="3">Line 3</option>
                  </select>
                  <span id="ng-line-and-4" style="display:none">and</span>
                  <select id="ng-line-select-4" style="display:none">
                    <option value="">-- Select --</option>
                    <option value="offline">Line Offline</option>
                    <option value="0">Line 0</option>
                    <option value="1">Line 1</option>
                    <option value="2">Line 2</option>
                    <option value="3">Line 3</option>
                  </select>
                </label><br>
                <p class="field-desc">Generate the chart using the selected parameters.</p>
                <button id="run-ng-chart-btn" title="Generate NG control chart">Run Chart</button>
              </div>
            </div>
            <div class="action-card">
              <h2>Run SQL Query</h2>
              <form id="sql-form">
                <div class="saved-query-bar">
                  <select id="saved-queries">
                    <option value="">-- Saved Queries --</option>
                  </select>
                </div>
                <textarea id="sql-query" rows="5" cols="60"></textarea><br>
                <button type="submit">Execute</button>
              </form>
              <table id="sql-results">
                <thead></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
        <div id="reports-tab" class="tab-content">
          <div class="report-section" id="daily-report">
            <h2>Daily Report</h2>
            <canvas id="daily-report-canvas" height="200" style="display:none"></canvas>
            <table id="daily-report-table" style="display:none"></table>
            <div class="dropdown">
              <button>Download</button>
              <div class="dropdown-content">
                <a href="#" id="download-daily-pdf">PDF</a>
                <a href="#" id="download-daily-xlsx">Excel</a>
              </div>
            </div>
            <p id="daily-report-summary" class="chart-summary"></p>
          </div>
          <div class="report-section" id="weekly-report">
            <h2>Weekly Report</h2>
            <canvas id="weekly-report-canvas" height="200" style="display:none"></canvas>
            <table id="weekly-report-table" style="display:none"></table>
            <div class="dropdown">
              <button>Download</button>
              <div class="dropdown-content">
                <a href="#" id="download-weekly-pdf">PDF</a>
                <a href="#" id="download-weekly-xlsx">Excel</a>
              </div>
            </div>
            <p id="weekly-report-summary" class="chart-summary"></p>
          </div>
          <div class="report-section" id="monthly-report">
            <h2>Monthly Report</h2>
            <canvas id="monthly-report-canvas" height="200" style="display:none"></canvas>
            <table id="monthly-report-table" style="display:none"></table>
            <div class="dropdown">
              <button>Download</button>
              <div class="dropdown-content">
                <a href="#" id="download-monthly-pdf">PDF</a>
                <a href="#" id="download-monthly-xlsx">Excel</a>
              </div>
            </div>
            <p id="monthly-report-summary" class="chart-summary"></p>
          </div>
          <div class="report-section" id="yearly-report">
            <h2>Yearly Report</h2>
            <canvas id="yearly-report-canvas" height="200" style="display:none"></canvas>
            <table id="yearly-report-table" style="display:none"></table>
            <div class="dropdown">
              <button>Download</button>
              <div class="dropdown-content">
                <a href="#" id="download-yearly-pdf">PDF</a>
                <a href="#" id="download-yearly-xlsx">Excel</a>
              </div>
            </div>
            <p id="yearly-report-summary" class="chart-summary"></p>
          </div>
        </div>
      </div>
      <datalist id="model-list">
        {% for name in model_names %}
        <option value="{{ name }}"></option>
        {% endfor %}
      </datalist>
      <div id="divider"></div>
      <div id="moat-table">
        <div id="model-filter-container">
          <label for="model-filter">Show Models</label>
          <select id="model-filter">
            <option value="all">All</option>
            <option value="smt">SMT</option>
            <option value="th">TH</option>
          </select>
        </div>
        <table>
          <thead><tr>
            <th>Model Name</th><th>Total Boards</th><th>Total Parts/Board</th>
            <th>Total Parts</th><th>NG Parts</th><th>NG PPM</th>
            <th>FalseCall Parts</th><th>FalseCall PPM</th><th>Upload Time</th>
          </tr></thead>
          <tbody>
          {% for row in moat %}
          <tr>
            <td>{{ row['model_name'] }}</td>
            <td>{{ row['total_boards'] }}</td>
            <td>{{ row['total_parts_per_board'] }}</td>
            <td>{{ row['total_parts'] }}</td>
            <td>{{ row['ng_parts'] }}</td>
            <td>{{ row['ng_ppm'] }}</td>
            <td>{{ row['falsecall_parts'] }}</td>
            <td>{{ row['falsecall_ppm'] }}</td>
            <td>{{ row['upload_time'] }}</td>
          </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Uploads Modal -->
    <div id="uploads-modal" class="modal">
      <div class="modal-content">
        <span id="close-uploads-modal" class="close">&times;</span>
        <h2>Uploaded Files</h2>
        <ul id="uploads-list"></ul>
      </div>
    </div>

    <!-- Chart Modal -->
    <div id="chart-modal" class="modal">
      <div class="modal-content">
        <span id="close-chart-modal" class="close">&times;</span>
        <h2>Control Chart - Avg FalseCall Rate</h2>
        <canvas id="chart-canvas" height="200"></canvas>
        <p id="fc-chart-summary" class="chart-summary"></p>
        <table id="fc-data-table"></table>
        <button id="download-fc-pdf">Download PDF</button>
      </div>
    </div>

    <div id="chart-ng-modal" class="modal">
      <div class="modal-content">
        <span id="close-chart-ng-modal" class="close">&times;</span>
        <h2>Control Chart - Avg NG Rate</h2>
        <canvas id="chart-ng-canvas" height="200"></canvas>
        <p id="ng-chart-summary" class="chart-summary"></p>
        <table id="ng-data-table"></table>
        <button id="download-ng-pdf">Download PDF</button>
      </div>
    </div>
  {% endif %}
{% endblock %}
